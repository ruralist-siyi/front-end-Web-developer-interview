#### Koa1 与 Koa2 的区别

最大的区别Koa1 基于 co 管理 Promise/Generator 中间件，而 Koa2 紧跟最新的 ES 规范，支持到了 Async Function（Koa1 不支持），两者中间件模型表现一致，只是语法底层不同。

#### Koa 与 Express 的区别

koa2与express 提供的API大致相同，express是大而全，内置了大多数的中间件，更让人省心，koa2不绑定任何的框架，干净简洁，小而精，更容易实现定制化，扩展性好。

express是没有提供ctx来提供上下流服务，需要更多的手动处理，express本身是不支持洋葱模型的数据流入流出能力的，需要引入其他的插件。

Koa 是基于新的语法特性，实现了 Promise 链传递，错误处理更友好，Koa 不绑定任何中间件，是干干净净的裸框架，需要什么就加什么，Koa 对流支持度很好，通过上下文对象的交叉引用让内部流程与请求和响应串联的更紧凑，如果 Express 是大而全，那么 Koa 就是小而精，二者定位不同，只不过 Koa 扩展性非常好，稍微组装几个中间件马上就能跟 Express 匹敌，代码质量也更高，设计理念更先进，语法特性也更超前。

#### Koa2中间件执行机制

1. 存储：以数组形式存储中间件。

2. 状态管理：所有的状态变更，都交给ctx对象，无需跨中间件传递参数。

3. 流程控制：以递归的方式进行中间件的执行，将下一个中间件的执行权交给正在执行的中间件，即洋葱圈模型。

4. 异步方案：用Promise包裹中间件的返回结果，以支持在上一个中间件内部实现Await逻辑。

##### 缺点

*缺点也比较明显：流程控制方案较弱*

在Koa体系下，因为当前中间件只能掌握下一个中间件的执行权，因此无法在运行时根据状态来动态决定中间件的执行顺序，只能通过静态路由，或者把部分服务封装成工具函数并在中间件文件中引入来解决。

#### AOP

面向切面编程(Aspect Oriented Programming，也叫面向方面编程)是一种非侵入式扩充对象、方法和函数行为的技术。
核心思想是通过对方法的拦截，在预编译或运行时进行动态代理，实现在方法被调用时可以以对业务代码无侵入的方式添加功能。